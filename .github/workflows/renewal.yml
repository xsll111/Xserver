name: ğŸš€ XServer VPS è‡ªåŠ¨ç»­æœŸ

on:
  schedule:
    # æ¯72å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆæ¯3å¤©çš„ 00:00 UTCï¼Œå³åŒ—äº¬æ—¶é—´ 08:00ï¼‰
    - cron: '0 0 */3 * *'

  workflow_dispatch:
    inputs:
      force_run:
        description: 'ğŸ”„ å¼ºåˆ¶æ‰§è¡Œï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰'
        required: true
        default: 'true'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  renewal:
    name: ğŸ”„ æ‰§è¡Œç»­æœŸä»»åŠ¡
    runs-on: ubuntu-latest

    # ========== ğŸ”§ å…³é”®ï¼šæ·»åŠ  FlareSolverr æœåŠ¡å®¹å™¨ ==========
    services:
      flaresolverr:
        image: ghcr.io/flaresolverr/flaresolverr:latest
        ports:
          - 8191:8191
        env:
          LOG_LEVEL: info
          CAPTCHA_SOLVER: none

    steps:
      # ========== ğŸ“¦ å‡†å¤‡é˜¶æ®µ ==========

      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£… Python ä¾èµ–
        run: |
          echo "ğŸ“¦ æ­£åœ¨å®‰è£… Python ä¾èµ–..."
          pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… Python ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸŒ å®‰è£… Playwright æµè§ˆå™¨
        run: |
          echo "ğŸŒ æ­£åœ¨å®‰è£… Chromium æµè§ˆå™¨..."
          playwright install chromium
          playwright install-deps chromium
          echo "âœ… æµè§ˆå™¨å®‰è£…å®Œæˆ"

      # ========== ğŸ§ª æµ‹è¯• FlareSolverr è¿æ¥ ==========
      - name: ğŸ” æµ‹è¯• FlareSolverr æœåŠ¡
        run: |
          echo "ğŸ” æµ‹è¯• FlareSolverr è¿æ¥..."
          max_retries=10
          retry_count=0

          while [ $retry_count -lt $max_retries ]; do
            if curl -s http://localhost:8191/v1 > /dev/null; then
              echo "âœ… FlareSolverr æœåŠ¡å·²å°±ç»ª"
              curl -X POST http://localhost:8191/v1 \
                -H "Content-Type: application/json" \
                -d '{"cmd":"sessions.list"}' | python3 -m json.tool
              break
            fi

            retry_count=$((retry_count + 1))
            echo "â³ ç­‰å¾… FlareSolverr å¯åŠ¨... ($retry_count/$max_retries)"
            sleep 3
          done

          if [ $retry_count -eq $max_retries ]; then
            echo "âŒ FlareSolverr å¯åŠ¨å¤±è´¥"
            exit 1
          fi

      # ========== ğŸŒ è·å– Runner å‡ºå£ IPï¼ˆç”¨äºæ£€æµ‹ä»£ç†æ˜¯å¦ç”Ÿæ•ˆï¼‰ ==========
      - name: ğŸŒ è·å– GitHub Runner å‡ºå£ IPï¼ˆç”¨äºæ£€æµ‹ä»£ç†æ˜¯å¦ç”Ÿæ•ˆï¼‰
        run: |
          echo "ğŸŒ è·å– GitHub Runner å‡ºå£ IP..."
          RUNNER_IP="$(curl -fsS https://api.ipify.org || true)"
          if [ -z "$RUNNER_IP" ]; then
            echo "âš ï¸ è·å– RUNNER_IP å¤±è´¥ï¼Œå°†è·³è¿‡ä»£ç†å¼ºæ ¡éªŒ"
          else
            echo "âœ… RUNNER_IP: $RUNNER_IP"
            echo "RUNNER_IP=$RUNNER_IP" >> $GITHUB_ENV
          fi

      # ========== ğŸš€ æ‰§è¡Œé˜¶æ®µ ==========

      - name: ğŸ¯ è¿è¡Œç»­æœŸè„šæœ¬
        env:
          # ğŸ” è´¦å·ä¿¡æ¯
          XSERVER_EMAIL: ${{ secrets.XSERVER_EMAIL }}
          XSERVER_PASSWORD: ${{ secrets.XSERVER_PASSWORD }}
          XSERVER_VPS_ID: ${{ secrets.XSERVER_VPS_ID }}

          # ğŸŒ ä»£ç†ï¼ˆSecretsï¼‰
          PROXY_SERVER: ${{ secrets.PROXY_SERVER }}

          # âœ… Runner å‡ºå£ IPï¼ˆä¸Šä¸€æ­¥å†™å…¥ GITHUB_ENVï¼‰
          RUNNER_IP: ${{ env.RUNNER_IP }}

          # ğŸ”§ FlareSolverr é…ç½®ï¼ˆä½¿ç”¨æœ¬åœ°æœåŠ¡ï¼‰
          FLARESOLVERR_URL: 'http://localhost:8191/v1'

          # ğŸ¤– éªŒè¯ç è¯†åˆ« API
          CAPTCHA_API_URL: ${{ secrets.CAPTCHA_API_URL }}

          # ğŸ“± Telegram é€šçŸ¥
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

          # âš™ï¸ è¿è¡Œé…ç½®
          USE_HEADLESS: 'false'
          WAIT_TIMEOUT: '30000'
        run: |
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œ XServer VPS è‡ªåŠ¨ç»­æœŸä»»åŠ¡..."
          echo "â° æ‰§è¡Œæ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ é…ç½®æ£€æŸ¥:"
          if [ -n "$XSERVER_EMAIL" ]; then echo "  âœ… XSERVER_EMAIL: å·²é…ç½®"; else echo "  âŒ XSERVER_EMAIL: æœªé…ç½®"; fi
          if [ -n "$XSERVER_PASSWORD" ]; then echo "  âœ… XSERVER_PASSWORD: å·²é…ç½®"; else echo "  âŒ XSERVER_PASSWORD: æœªé…ç½®"; fi
          if [ -n "$XSERVER_VPS_ID" ]; then echo "  âœ… XSERVER_VPS_ID: å·²é…ç½®"; else echo "  âŒ XSERVER_VPS_ID: æœªé…ç½®"; fi
          if [ -n "$PROXY_SERVER" ]; then echo "  âœ… PROXY_SERVER: å·²é…ç½®"; else echo "  âš ï¸ PROXY_SERVER: æœªé…ç½®"; fi
          if [ -n "$RUNNER_IP" ]; then echo "  âœ… RUNNER_IP: $RUNNER_IP"; else echo "  âš ï¸ RUNNER_IP: æœªè·å–åˆ°"; fi
          if [ -n "$CAPTCHA_API_URL" ]; then echo "  âœ… CAPTCHA_API_URL: å·²é…ç½®"; else echo "  âš ï¸ CAPTCHA_API_URL: æœªé…ç½®(å°†ä½¿ç”¨è„šæœ¬é»˜è®¤å€¼)"; fi
          if [ -n "$FLARESOLVERR_URL" ]; then echo "  âœ… FlareSolverr: $FLARESOLVERR_URL"; else echo "  âŒ FlareSolverr: æœªé…ç½®"; fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ ! -f "renewal.py" ]; then
            echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° renewal.py æ–‡ä»¶"
            exit 1
          fi

          echo "ğŸ“‚ å½“å‰ç›®å½•: $(pwd)"
          ls -lh renewal.py

          # å…³é”®ï¼šåœ¨è™šæ‹Ÿæ˜¾ç¤ºå™¨é‡Œè¿è¡Œï¼Œæ»¡è¶³ headless=False
          xvfb-run -a python3 renewal.py

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… ç»­æœŸä»»åŠ¡æ‰§è¡Œå®Œæˆ"

      # ========== ğŸ“Š ç»“æœå¤„ç† ==========
      - name: ğŸ“Š æ˜¾ç¤ºè¿è¡Œç»“æœï¼ˆå« Artifact è·å–æç¤ºï¼‰
        if: always()
        run: |
          echo "ğŸ“Š ========== è¿è¡Œç»“æœæ‘˜è¦ =========="
          if [ -f "README.md" ]; then
            echo "ğŸ“„ README.md:"
            cat README.md
          else
            echo "âš ï¸ æœªæ‰¾åˆ° README.md"
          fi
          echo ""

          if [ -f "cache.json" ]; then
            echo "ğŸ—ƒï¸ cache.json:"
            cat cache.json | python3 -m json.tool
          else
            echo "â„¹ï¸ æœªç”Ÿæˆ cache.json"
          fi
          echo ""

          echo "ğŸ“ æœ€æ–°æ—¥å¿—(æœ€å 120 è¡Œ):"
          if [ -f "renewal.log" ]; then
            tail -n 120 renewal.log
          else
            echo "âš ï¸ æœªæ‰¾åˆ° renewal.log"
          fi
          echo ""
          echo "ğŸ“¦ è‹¥ Playwright å´©æºƒ / éœ€è¦æˆªå›¾æ’æŸ¥ï¼šè¯·åœ¨æœ¬æ¬¡ Run é¡µé¢é¡¶éƒ¨æ‰¾åˆ° Artifacts ä¸‹è½½ renewal-logs-<run_number>"

      - name: ğŸ“¦ ä¸Šä¼ è¿è¡Œæ—¥å¿—ä¸æˆªå›¾ï¼ˆArtifactsï¼‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: renewal-logs-${{ github.run_number }}
          path: |
            renewal.log
            *.png
            cache.json
          retention-days: 30

      - name: ğŸ’¾ æäº¤çŠ¶æ€æ›´æ–°
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot ğŸ¤–"
          [ -f "README.md" ] && git add README.md
          [ -f "cache.json" ] && git add cache.json
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ— éœ€æäº¤"
          else
            git commit -m "ğŸ”„ çŠ¶æ€æ›´æ–° [skip ci]"
            git push
          fi

  stats:
    name: ğŸ“ˆ æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
    runs-on: ubuntu-latest
    needs: renewal
    if: always()
    steps:
      - name: ğŸ“Š è¿è¡Œç»Ÿè®¡
        run: |
          echo "ğŸ“ˆ ========== XServer VPS ç»­æœŸç»Ÿè®¡ =========="
          echo "ğŸ”¢ è¿è¡Œæ¬¡æ•°: #${{ github.run_number }}"
          echo "â° æ‰§è¡Œæ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
